---
title: "ðŸŒ¦ Weather Memory"
subtitle: "Do flight delays 'remember' yesterday's weather? Evidence from nycflights13."
description: "Bad weather can disrupt schedules, but does the pain linger after skies clear? This short data story explores whether today's flight delays still carry the fingerprint of yesterday's weather â€” a simple form of system memory."
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    smooth-scroll: true
    df-print: paged
    anchor-sections: true
execute:
  warning: false
  message: false
  echo: true
  freeze: auto
---

## Goal & approach

**Goal.** Test whether *yesterday's* weather helps predict *today's* flight delays at NYC airports, beyond the effect of *today's* weather.

**Method (high level).** 1) Join flights with hourly weather, aggregate to a **daily** panel by airport; 2) create **lagged weather** features (yesterday's precip, wind, visibility, temperature); 3) model today's mean departure delay using both **today** and **yesterday** weather plus calendar controls; 4) visualize the patterns and airport differences; 5) run a small **what-if** experiment.

### Setup

```{r}
library(tidyverse)
library(lubridate)
library(nycflights13)
library(broom)
library(gt)
library(scales)
library(modelr)
library(plotly)  # interactivity

# Use site-wide theme if present; otherwise a quiet fallback
quiet_theme <- if (exists("quiet_theme")) quiet_theme else function() {
  theme_minimal(base_size = 12) +
    theme(
      panel.grid.minor = element_blank(),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      plot.title = element_text(face = "bold"),
      legend.position = "bottom"
    )
}
```

## Build a daily panel: flights Ã— weather

**Goal â†’** Create a tidy daily dataset by airport (JFK/LGA/EWR) with delay outcomes and weather inputs.

```{r}
# Flights (2013) â†’ daily outcomes by origin
fl_daily <- flights %>%
  mutate(
    date = make_date(year, month, day),
    cancelled = is.na(dep_time)
  ) %>%
  group_by(origin, date) %>%
  summarise(
    n_flights      = n(),
    cancel_rate    = mean(cancelled),
    mean_dep_delay = mean(dep_delay[!cancelled], na.rm = TRUE),
    .groups = "drop"
  )

# Weather (hourly) â†’ daily inputs by origin
wx_daily <- weather %>%
  mutate(date = as_date(time_hour)) %>%
  group_by(origin, date) %>%
  summarise(
    precip_in = sum(replace_na(precip, 0)),      # inches
    wind_mph  = mean(wind_speed, na.rm = TRUE),  # mph
    visib_mi  = mean(visib, na.rm = TRUE),       # miles
    temp_F    = mean(temp, na.rm = TRUE),        # Â°F
    .groups = "drop"
  ) %>%
  mutate(
    precip_mm = precip_in * 25.4,                # convert to mm
    rain_day  = as.integer(precip_in > 0)
  )

# Join and create 1-day lags per-airport
panel_daily <- fl_daily %>%
  inner_join(wx_daily, by = c("origin","date")) %>%
  arrange(origin, date) %>%
  group_by(origin) %>%
  mutate(
    precip_mm_lag1 = lag(precip_mm, 1),
    wind_mph_lag1  = lag(wind_mph, 1),
    visib_mi_lag1  = lag(visib_mi, 1),
    temp_F_lag1    = lag(temp_F, 1),
    rain_yday      = lag(rain_day, 1),
    dow   = wday(date, label = TRUE, abbr = TRUE),
    month = month(date, label = TRUE, abbr = TRUE)
  ) %>%
  ungroup()

# Keep rows with both today and lagged weather present
panel_model <- panel_daily %>%
  drop_na(
    mean_dep_delay,
    precip_mm, wind_mph, visib_mi, temp_F,
    precip_mm_lag1, wind_mph_lag1, visib_mi_lag1, temp_F_lag1
  )
```

## First look: does delay rise with yesterdayâ€™s rain?

```{r}
p_scatter <- panel_model %>%
  ggplot(aes(x = precip_mm_lag1, y = mean_dep_delay)) +
  geom_point(alpha = 0.4, size = 1) +
  geom_smooth(method = "loess", se = TRUE) +
  facet_wrap(~ origin, nrow = 1) +
  labs(
    title = "Weather memory: yesterday's rain vs. today's mean departure delay",
    x = "Yesterday's precipitation (mm)",
    y = "Today's mean departure delay (minutes)",
    caption = "Dots are daily airport means in 2013; line = loess trend."
  ) +
  quiet_theme()

p_scatter
```

```{r}
subplot <- ggplotly(p_scatter, tooltip = c("x", "y")) %>%
  layout(title = list(text = "Weather memory: Yesterday's rain vs. today's delays"))

subplot
```

## Today vs. yesterday: contrasting weather states

```{r}
p_contrast <- ggplot(panel_model, aes(precip_mm_lag1, precip_mm)) +
  stat_summary_2d(aes(z = mean_dep_delay), bins = 20) +
  facet_wrap(~ origin, nrow = 1) +
  labs(
    title = "Today vs yesterday precipitation (colored by mean delay)",
    x = "Yesterday precip (mm)", y = "Today precip (mm)", fill = "Mean delay (min)"
  ) +
  quiet_theme()

p_contrast
```

## Modeling: does yesterdayâ€™s weather matter after controls?

```{r}
model_full <- lm(
  mean_dep_delay ~ precip_mm_lag1 + wind_mph_lag1 + visib_mi_lag1 + temp_F_lag1 +
    precip_mm + wind_mph + visib_mi + temp_F + origin + dow + month,
  data = panel_model
)

tidy_coefs <- broom::tidy(model_full, conf.int = TRUE) %>%
  filter(term %in% c("precip_mm_lag1","wind_mph_lag1","visib_mi_lag1","temp_F_lag1")) %>%
  mutate(term = recode(term,
    precip_mm_lag1 = "Yesterday precip (mm)",
    wind_mph_lag1  = "Yesterday wind (mph)",
    visib_mi_lag1  = "Yesterday visibility (mi)",
    temp_F_lag1    = "Yesterday temperature (Â°F)"
  ))

gt_tbl <- tidy_coefs %>%
  select(term, estimate, conf.low, conf.high, p.value) %>%
  mutate(across(c(estimate, conf.low, conf.high), ~round(., 3)),
         p.value = format.pval(p.value, digits = 3, eps = 0.001)) %>%
  gt::gt() %>%
  gt::tab_header(title = "Lagged weather coefficients (partial effects)") %>%
  gt::fmt_markdown(columns = 1) %>%
  gt::cols_label(
    term = "Predictor",
    estimate = "Estimate",
    conf.low = "CI low",
    conf.high = "CI high",
    p.value = "p"
  )

gt_tbl
```

## Airport where memory is strongest

```{r}
by_airport <- panel_model %>%
  group_by(origin) %>%
  group_modify(~ broom::tidy(lm(
      mean_dep_delay ~ precip_mm_lag1 + wind_mph_lag1 + visib_mi_lag1 + temp_F_lag1 +
        precip_mm + wind_mph + visib_mi + temp_F + dow + month,
      data = .x
    ), conf.int = TRUE)) %>%
  ungroup() %>%
  filter(term == "precip_mm_lag1")

p_airport <- by_airport %>%
  ggplot(aes(x = reorder(origin, estimate), y = estimate)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  coord_flip() +
  labs(title = "Where is the weather-memory effect strongest?",
       subtitle = "Coefficient on *yesterday precipitation* by airport (separate regressions)",
       x = "Airport", y = "Lag precip coefficient (minutes per mm)",
       caption = "Points = estimates; bars = 95% CI.") +
  quiet_theme()

p_airport
```

## Cancellation link: does yesterdayâ€™s rain raise todayâ€™s cancels?

```{r}
cor_overall <- panel_model %>%
  summarise(cor = cor(precip_mm_lag1, cancel_rate, use = "complete.obs"))

cor_by_airport <- panel_model %>%
  group_by(origin) %>%
  summarise(cor = cor(precip_mm_lag1, cancel_rate, use = "complete.obs"))

cor_overall; cor_by_airport
```

## What-if: set yesterdayâ€™s rain to zero

```{r}
pred_obs <- augment(model_full, data = panel_model) %>% select(origin, date, .fitted)

pred_counterf <- panel_model %>%
  mutate(precip_mm_lag1 = 0) %>%
  add_predictions(model_full) %>%
  transmute(origin, date, fitted_zero_lag_rain = pred)

what_if <- pred_obs %>%
  left_join(pred_counterf, by = c("origin","date")) %>%
  left_join(panel_model %>% select(origin, date, mean_dep_delay), by = c("origin","date")) %>%
  mutate(
    delta_minutes = .fitted - fitted_zero_lag_rain,
    ontime_rate_obs = pmax(0, 1 - mean_dep_delay/15),
    ontime_rate_cf  = pmax(0, 1 - fitted_zero_lag_rain/15),
    ontime_gain_pct = (ontime_rate_cf - ontime_rate_obs) * 100
  )

summary(what_if$ontime_gain_pct)

p_whatif <- what_if %>%
  ggplot(aes(x = ontime_gain_pct)) +
  geom_histogram(bins = 30, alpha = 0.7) +
  facet_wrap(~ origin, nrow = 1) +
  labs(title = "What-if yesterday were dry: implied on-time rate improvement",
       x = "Percentage points (counterfactual âˆ’ observed)", y = "Days",
       caption = "Back-of-envelope: converts minutes to on-time share via a 15-minute threshold on the mean.") +
  quiet_theme()

p_whatif
```

## Bonus: Today vs. Yesterday on a joint scatter (hoverable)

```{r}
p_scatter2 <- panel_model %>%
  ggplot(aes(x = precip_mm_lag1, y = precip_mm, size = mean_dep_delay, text = paste(date, origin))) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ origin) +
  labs(title = "Today vs. yesterday precipitation (point size = today's mean delay)",
       x = "Yesterday (mm)", y = "Today (mm)") +
  quiet_theme()

ggplotly(p_scatter2, tooltip = c("text", "x", "y")) %>%
  layout(
    margin = list(t = 100),  # more top room
    title = list(
      text = "<b>Today vs. yesterday precipitation (point size = today's mean delay)</b>",
      font = list(size = 12),
      x = 0.5, xanchor = "center"
    )
  )

```

## Story beats

**We asked:** Do storms leave a *hangover* in the schedule?

**We did:** Calculated daily delays by airport, then compared them to both **todayâ€™s** and **yesterdayâ€™s** precipitation, wind, visibility, and temperature.

**We found:** Yesterdayâ€™s weather often remains a statistically meaningful predictor of todayâ€™s delays, even when we control for **todayâ€™s** weather and calendar effects.

**Why it matters:** Recovery is a process. Aircraft and crews are networked; disruptions propagate and decay, sometimes over more than one day.

## Practical implications

-   **Scheduling & rotations:** Build buffers the day *after* major weather events; rotate slack where the lag effect is strongest.
-   **Maintenance & de-icing ops:** Staff for spillover demand on *wetâ†’dry* transitions.
-   **Passenger comms:** Proactive alerts for potential residual delays the day after storms.

## Limitations

-   We use **means** of delays; distributional effects (e.g., big tails) are not fully captured.
-   Only **1-day** memory is modeled; longer lags may matter.
-   Weather aggregation is **daily**; within-day timing (e.g., late-night rain) could drive stronger effects.
-   Linear models are a simplification; non-linearities and interactions (e.g., wind Ã— visibility) are likely.

## References & Credits

-   Data: `nycflights13` (Hadley Wickham et al.) â€” CRAN: <https://CRAN.R-project.org/package=nycflights13>
-   Packages: `tidyverse`, `lubridate`, `broom`, `gt`, `plotly`, `modelr`.
-   Theme: falls back to a quiet minimal style if your siteâ€™s `quiet_theme()` is not available.

## Gentle call to curiosity

*What other forms of memory might our systems hold?*
